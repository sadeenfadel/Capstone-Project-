{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/order_detail.css' %}">
{% endblock %}

{% block content %}
<div class="order-detail-container">
  <h2>üßæ Order #{{ order.id }} Details</h2>

  <div class="order-info">
    <p><strong>Placed by:</strong> {{ order.user.username }}</p>
    <p><strong>Date:</strong> {{ order.order_date|date:"Y-m-d H:i" }}</p>
    <p><strong>Status:</strong>
      <span class="status {{ order.status }}">{{ order.status|title }}</span>
    </p>
  </div>

  <table class="order-items-table">
    <thead>
      <tr>
        <th>Bouquet</th>
        <th>Quantity</th>
        <th>Unit Price</th>
        <th>Subtotal</th>
        {% if not request.user.is_superuser %}
          <th>Action</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for item in order_items %}
      <tr>
        <td>
          {% if item.bouquet %}
            {{ item.bouquet.name }}
          {% else %}
            <span class="deleted">{{ item.bouquet_name }} (deleted)</span>
          {% endif %}
        </td>

        <td>
          {% if not request.user.is_superuser %}
          <!-- form ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÉŸÖŸäÿ© -->
          <form action="{% url 'edit_quantity' order.id item.id %}" method="post" class="edit-qty-form">
            {% csrf_token %}
            <input type="number" name="quantity" value="{{ item.quantity }}" min="1" class="quantity-input">
          </form>
          {% else %}
            {{ item.quantity }}
          {% endif %}
        </td>

        <td>${{ item.bouquet.total_price|floatformat:2 }}</td>
        <td>${{ item.subtotal|floatformat:2 }}</td>

        {% if not request.user.is_superuser %}
        <td class="action-cell">
          <a href="{% url 'edit_quantity' order.id item.bouquet.id %}" class="btn-edit">‚úèÔ∏è Edit</a>
          <a href="{% url 'deleteboq' order.id item.bouquet.id %}" class="btn-remove"
             onclick="return confirm('Are you sure you want to remove this bouquet?');">‚ùå Remove</a>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>

    <tfoot>
      <tr>
        <td colspan="{% if request.user.is_superuser %}4{% else %}5{% endif %}" class="total-label">
          Total:
        </td>
        <td class="total-value">${{ order.total_price|floatformat:2 }}</td>
      </tr>
    </tfoot>
  </table>

  <div class="order-actions">
    {% if request.user.is_superuser %}
      {% if order.status != "confirmed" %}
        <form action="{% url 'cancel_order' order.id %}" method="post">
          {% csrf_token %}
          <button type="submit" class="btn-cancel"
                  onclick="return confirm('Are you sure you want to cancel this order?');">
            ‚ùå Cancel Order
          </button>
        </form>
      {% else %}
        <p>Order already confirmed by user.</p>
      {% endif %}
    {% else %}
      {% if order.status == "ready" %}
        <form action="{% url 'confirm_order' order.id %}" method="post">
          {% csrf_token %}
          <button type="submit" class="btn-user">Confirm Received</button>
        </form>
      {% elif order.status == "confirmed" %}
        <p class="confirmed-msg">‚úÖ You have confirmed this order.</p>
      {% else %}
        <p class="pending-msg">‚è≥ Your order is being prepared.</p>
      {% endif %}
    {% endif %}
  </div>

  {% if request.user.is_superuser %}
    <a href="{% url 'order_list' %}" class="back-link">‚Üê Back to Orders</a>
  {% else %}
    <a href="{% url 'bouquet_list'%}" class="back-link">‚Üê Back to Orders</a>
  {% endif %}
</div>
{% endblock %}
